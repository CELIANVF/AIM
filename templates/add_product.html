{% extends "layout.html" %}

{% block title %}Ajouter Produit{% endblock %}

{% block content %}
<div class="header-with-actions">
    <div>
        <h1>➕ Ajouter un produit</h1>
        <p class="muted">Remplissez les informations du nouveau produit</p>
    </div>
    <a href="/products" class="btn btn-outline">← Retour</a>
</div>

<div class="form-card">
    <form method="post">
        <div class="form-row">
            <div class="form-group">
                <label>Catégorie *</label>
                <select name="category_id" id="category_select" required>
                    {% for c in categories %}
                    <option value="{{ c.id }}" data-has-size="{{ c.has_size|lower }}" data-has-power="{{ c.has_power|lower }}" data-has-model="{{ c.has_model|lower }}" data-custom-fields="{{ c.custom_fields or '' }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Marque</label>
                <input type="text" name="brand" placeholder="Ex: Hoyt, Samick...">
            </div>
        </div>

        <div class="form-group">
            <label>État</label>
            <select name="state">
                <option value="stock">✓ Disponible</option>
                <option value="broken">✗ Cassé / Hors service</option>
            </select>
        </div>

        <div id="size_field" style="display: none;" class="form-group">
            <label>Taille</label>
            <input type="text" name="size" placeholder="Ex: M, L, 28...">
        </div>

        <div id="power_field" style="display: none;" class="form-group">
            <label>Puissance</label>
            <input type="text" name="power" placeholder="Ex: 20#, 25#...">
        </div>

        <div id="model_field" class="form-group">
            <label>Modèle</label>
            <input type="text" name="model" placeholder="Ex: Formula, Nexus...">
        </div>

        <div class="form-group">
            <label>Commentaires</label>
            <textarea name="comments" placeholder="Notes ou remarques supplémentaires..."></textarea>
        </div>

        <div id="custom_fields"></div>

        <div class="action-group" style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border)">
            <button class="btn btn-primary" type="submit">✓ Ajouter le produit</button>
            <a href="/products" class="btn btn-outline">Annuler</a>
        </div>
    </form>
</div>

<script>
    const categorySelect = document.getElementById('category_select');
    const sizeField = document.getElementById('size_field');
    const powerField = document.getElementById('power_field');
    const modelField = document.getElementById('model_field');
    const customFieldsDiv = document.getElementById('custom_fields');

    function updateFields() {
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const hasSize = selectedOption.getAttribute('data-has-size') === 'true';
        const hasPower = selectedOption.getAttribute('data-has-power') === 'true';
        const hasModel = selectedOption.getAttribute('data-has-model') === 'true';
        const customFields = selectedOption.getAttribute('data-custom-fields') || '';

        sizeField.style.display = hasSize ? 'block' : 'none';
        powerField.style.display = hasPower ? 'block' : 'none';
        modelField.style.display = hasModel ? 'block' : 'none';

        customFieldsDiv.innerHTML = '';

        if (customFields.trim()) {
            const fields = customFields.split(',').map(f => f.trim()).filter(f => f);
            fields.forEach(field => {
                const parts = field.split(':');
                const labelText = parts[0].trim();
                const spec = parts[1] ? parts[1].trim() : null;
                const nameAttr = 'custom_' + labelText.replace(/\s+/g, '_').toLowerCase();

                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = labelText;

                if (spec && spec.includes('/')) {
                    const select = document.createElement('select');
                    select.name = nameAttr;
                    spec.split('/').map(o => o.trim()).filter(o => o).forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        select.appendChild(option);
                    });
                    formGroup.appendChild(label);
                    formGroup.appendChild(select);
                } else if (spec && spec.toLowerCase() === 'date') {
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.name = nameAttr;
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = nameAttr;
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                }

                customFieldsDiv.appendChild(formGroup);
            });
        }
    }

    categorySelect.addEventListener('change', updateFields);
    updateFields();
</script>
{% endblock %}
