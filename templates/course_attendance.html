{% extends "layout.html" %}

{% block title %}Pr√©sences - {{ course.name }}{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
    <div>
        <h1 style="margin:0">‚úì Pr√©sences - {{ course.name }}</h1>
        <p class="muted" style="margin:4px 0 0 0">Gestion de la pr√©sence des archers</p>
    </div>
    <a href="{{ url_for('courses') }}" class="btn btn-outline">‚Üê Retour aux cours</a>
</div>

<div style="display:grid;grid-template-columns:1fr;gap:24px">
    <div class="card">
        <h2 style="margin-top:0">Marquer les pr√©sences</h2>
        {% if course.archers %}
            <form method="POST" action="{{ url_for('mark_attendance', course_id=course.id) }}">
                <div class="form-group" style="margin-bottom:20px">
                    <label for="date">Choisir une date</label>
                    <input type="date" id="date" name="date" required value="{{ today }}">
                </div>

                <div style="border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
                    {% for archer in course.archers %}
                        <div style="padding:16px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:12px">
                            <input type="checkbox" id="archer_{{ archer.id }}" name="archer_{{ archer.id }}" style="width:18px;height:18px;cursor:pointer">
                            <label for="archer_{{ archer.id }}" style="margin:0;flex:1;cursor:pointer;font-weight:500">
                                {{ archer.name }}
                            </label>
                        </div>
                    {% endfor %}
                </div>

                <div style="display:flex;gap:12px;margin-top:20px">
                    <button type="submit" class="btn btn-primary">‚úì Enregistrer les pr√©sences</button>
                </div>
            </form>
        {% else %}
            <p class="muted">Aucun archer inscrit √† ce cours. Ajoutez des archers d'abord.</p>
            <a href="{{ url_for('course_archers', course_id=course.id) }}" class="btn btn-primary" style="margin-top:16px">üë• G√©rer les archers</a>
        {% endif %}
    </div>

    {% if attendance_records %}
    <div class="card">
        <h2 style="margin-top:0">Historique des pr√©sences</h2>
        <div style="overflow-x:auto">
            <table class="table" style="margin:0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Archers pr√©sents</th>
                        <th>Taux de pr√©sence</th>
                    </tr>
                </thead>
                <tbody>
                    {% set date_groups = {} %}
                    {% for record in attendance_records %}
                        {% if record.date.isoformat() not in date_groups %}
                            {% set _ = date_groups.update({record.date.isoformat(): []}) %}
                        {% endif %}
                        {% set _ = date_groups[record.date.isoformat()].append(record) %}
                    {% endfor %}
                    {% for date_str in date_groups|sort(reverse=True) %}
                        {% set records = date_groups[date_str] %}
                        {% set present_count = records|selectattr('present', 'equalto', True)|list|length %}
                        {% set total_count = records|length %}
                        {% set percentage = ((present_count / total_count) * 100)|int if total_count > 0 else 0 %}
                        <tr>
                            <td>{{ date_str }}</td>
                            <td>
                                {% for record in records %}
                                    {% if record.present %}
                                        <span style="display:inline-block;background:var(--success-light);color:var(--success);padding:4px 8px;border-radius:4px;font-size:12px;margin:2px">
                                            {{ record.archer.first_name or record.archer.last_name }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                <span class="badge badge-{% if percentage >= 80 %}success{% elif percentage >= 60 %}warning{% else %}danger{% endif %}">
                                    {{ percentage }}%
                                </span>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
